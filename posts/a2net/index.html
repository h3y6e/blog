<!DOCTYPE html> <html lang=ja > <script async src="https://www.googletagmanager.com/gtag/js?id=G-9SVT03FL33" ></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag("js", new Date()); gtag("config", "G-9SVT03FL33"); </script> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width,initial-scale=1,maximum-scale=1" /> <meta name=author  content=5ebec  /> <meta name=theme-color  content="#a5ebec" /> <link rel=stylesheet  href="/css/a5ebec.css" /> <link rel=icon  href="/assets/favicon/favicon.ico" /> <link rel=apple-touch-icon  href="/assets/favicon/apple-touch-icon.png" /> <meta property="og:site_name" content="#a5ebec" /> <meta property="og:image" content="https://blog.5ebec.dev/img/2020-12-18/rack.jpg" /> <meta name="twitter:card" content=summary_large_image  /> <meta name="twitter:site" content="@5ebec" /> <meta name="twitter:creator" content="@5ebec" /> <title> A2ネットを改善しよう :: #a5ebec </title> <meta name=description  content="寮のネットワークを改善している話。" /> <meta property="og:type" content=article  /> <meta property="og:title" content="A2ネットを改善しよう :: #a5ebec" /> <meta property="og:url" content="https://blog.5ebec.dev/posts/a2net/index.html" /> <meta property="og:description" content="寮のネットワークを改善している話。" /> <header> <div class=header-inner > <div class=header-logo > <a href="/"><div class=logo >#a5ebec</div></a> </div> <label for=trigger  class=menu >menu</label> </div> <input type=checkbox  id=trigger  /> <nav> <ul> <li><a href="/">Posts</a> <li><a href="/tags">Tags</a> <li><a href="/about">About</a> </ul> </nav> </header> <div class=franklin-headline > <h1 class=title >A2ネットを改善しよう</h1> <div class=date >2020-12-18</div><span class=tags ><a href="/tags/kmnac">#kmnac</a> <a href="/tags/adventcalendar">#adventcalendar</a> </span></div><div class=franklin-toc ><ol><li><a href="#a2_ネットとは">A2 ネットとは</a><li><a href="#春何があったのか">春、何があったのか</a><li><a href="#やったこと">やったこと</a><ol><li><a href="#各居室で管理されていたアクセスポイントを_a2_ネットが部分的に管理出来るようにした">各居室で管理されていたアクセスポイントを A2 ネットが部分的に管理出来るようにした</a><li><a href="#プランを変更した">プランを変更した</a><li><a href="#機器を新しくした">機器を新しくした</a><li><a href="#dhcp_サーバを構築した">DHCP サーバを構築した</a><li><a href="#ドキュメント等を_github_google_drive_で管理するようにした">ドキュメント等を GitHub &#43; Google Drive で管理するようにした</a></ol><li><a href="#結果">結果</a><li><a href="#結論と宣伝">結論と宣伝</a></ol></div> <div class=franklin-content > <p>この記事は、<a href="https://adventar.org/calendars/4930">Kumano dorm. Advent Calendar 2020</a> の 18 日目の記事です。</p> <p>こんにちは。A2 に住んでいる者です。<br/> A2 ネットを管理しているのですが、今年は色々改善したので、その話をします。</p> <h2 id="a2_ネットとは"><a href="#a2_ネットとは" class=header-anchor >A2 ネットとは</a></h2> <p>熊野寮の A2 ブロックに所属する人が使用出来るネットワーク（無線 LAN 及び有線 LAN）です。 1 人の管理者がプロパイダと 1 回線を契約し、A2 ネットの利用者が管理者へ利用料を払うという形式を取っています。</p> <p>談話室内での利用は無料としています<sup id="fnref:談話室無料"><a href="#fndef:談話室無料" class=fnref >[1]</a></sup> が、居室・食堂・ロビー・事務室で利用するには利用料を徴収しており、現在の値段は<strong>1 人あたり 3,500 円/年</strong>です。</p> <table class=fndef  id="fndef:談話室無料"> <tr> <td class=fndef-backref ><a href="#fnref:談話室無料">[1]</a> <td class=fndef-content >これは談話室に人が集まり、ブロックの団結を強固なものにすることを願っているためです。<br/>今年は談話室にあまり集まれませんでしたが…。 </table> <h2 id="春何があったのか"><a href="#春何があったのか" class=header-anchor >春、何があったのか</a></h2> <p>4 月、COVID-19 の影響でほぼ全ての講義、ミーティング、研究会などがリモートになりました。 また、寮内の全ての新歓、全ての会議をオンライン化することになりました。 その関係で、希望者に対して各居室で利用出来る無線 LAN を無料開放することが決定されました。</p> <p>しかし、この頃の A2 ネット（以下、「旧 A2 ネット」とします）は不可逆的なシステムでした。 旧 A2 ネットは談話室・食堂・ロビーには無線 LAN を供給していましたが、居室には有線 LAN を供給していました。 そのため、居室で無線 LAN を利用するためには利用者がアクセスポイントを各自で調達する必要がありました。</p> <p>旧 A2 ネットで無線 LAN の無料開放をするということは即ち、旧 A2 ネットの管理外にある各居室のアクセスポイントの SSID とパスワードを非加入者が知るということです<sup id="fnref:そもそも論"><a href="#fndef:そもそも論" class=fnref >[2]</a></sup>。 非加入者の頭を殴ってパスワードに関する記憶を飛ばせたら楽なのですが、そう簡単ではありません。 無料開放の終了後は管理外にあるアクセスポイントをどうにかして A2 ネット管理下に置き、非加入者が知らないパスワードに変更する必要がありました。</p> <p>以下に旧 A2 ネットの構成図を示しておきます。黒い矢印は有線で接続しているという意味ですが、厳密な図ではありません。 <figure> <img src="/img/2020-12-18/a2net_old.png"/> <figcaption>旧A2ネット構成図。</figcaption> </figure> </p> <p>6 月、COVID-19 が一旦落ち着きを見せた<sup id="fnref:ほんまか"><a href="#fndef:ほんまか" class=fnref >[3]</a></sup> こともあり、無料開放が終了しました。</p> <p><table class=fndef  id="fndef:そもそも論"> <tr> <td class=fndef-backref ><a href="#fnref:そもそも論">[2]</a> <td class=fndef-content >そもそもアクセスポイントの裏などには SSID とパスワードが書いてあるものが多いですし、普通の人はそれを変更せずにそのまま使うので、簡単にフリーライド出来る状態でした。<br/>なんでこんな性善説の体現みたいな制度にしているんだと思う方もいると思いますので、このシステムの良いところを説明しておきます。まず、アクセスポイントの費用を各居室の人々が負担するので、A2 ネット利用料に関しては加入者が少なくても低価格で提供出来ます。また、居室のアクセスポイントで何らかのトラブルが起きたとしても基本的には加入者が自分で解決する必要があるので、管理者の手間が減るという点もあります。 </table> <table class=fndef  id="fndef:ほんまか"> <tr> <td class=fndef-backref ><a href="#fnref:ほんまか">[3]</a> <td class=fndef-content >まあ、その後また感染者数が増加し始めたんですけどもね。 </table> </p> <h2 id="やったこと"><a href="#やったこと" class=header-anchor >やったこと</a></h2> <p>無料開放を受けて、やったことを以下に記します。</p> <h3 id="各居室で管理されていたアクセスポイントを_a2_ネットが部分的に管理出来るようにした"><a href="#各居室で管理されていたアクセスポイントを_a2_ネットが部分的に管理出来るようにした" class=header-anchor >各居室で管理されていたアクセスポイントを A2 ネットが部分的に管理出来るようにした</a></h3> <p>まずはこれです。</p> <p>今まで各居室の人々が管理していたものを A2 ネットが取り上げる権限は持っていないので、その機器自体ではなく、各居室のアクセスポイントのパスワードを変える権限を A2 ネット管理者に付与するという形で A2 ブロック構成員に合意を取りました。</p> <p>また、居室内を含む全ての無線 LAN ルーターを A2 ネットで一元管理したほうが、今回のような緊急事態に対して柔軟に対応出来ると考えたため、今後アクセスポイントを居室に新しく導入する場合は A2 ネットが購入し管理することにしました。</p> <h3 id="プランを変更した"><a href="#プランを変更した" class=header-anchor >プランを変更した</a></h3> <p>A2 ネットは eo 光で光回線を契約しているのですが、5/10Gbps が利用可能になったタイミング<sup id="fnref:タイミング"><a href="#fndef:タイミング" class=fnref >[4]</a></sup> ですぐに契約を 1Gbps から 5Gbps のプランに変更しました。 流石に A2 ブロック構成員 44 人が同時に使用することは無いとはいえ、ビデオ会議等は帯域を大きく占領するので 1Gbps だと厳しいものがありました。</p> <p>別に 10Gbps でも良かったんですが、新しく買う機器にいくら金を使うかが未知数だったのでケチりました。</p> <h3 id="機器を新しくした"><a href="#機器を新しくした" class=header-anchor >機器を新しくした</a></h3> <h4 id="無線_lan_ルーター"><a href="#無線_lan_ルーター" class=header-anchor >無線 LAN ルーター</a></h4> <p>先述したように旧 A2 ネットでは居室には有線 LAN のみしか提供していなかったため、そもそもアクセスポイントが無い部屋もありました。 そこで、アクセスポイントが無い部屋には新たに設置しました。</p> <p>大本となる談話室の無線 LAN ルーターは、IPv6 対応・Wi-Fi6 対応・10GbE ポートを搭載したものに変えました。</p> <p>食堂とロビーにもアクセスポイントを置いていたのですが、食堂・ロビー・事務室をカバー出来るほどの強度を持っていなかったので、新しいものに変えました。 新しいアクセスポイントは食堂と事務室に配置したのですが、食堂から事務室までは有線で接続することが難しそうだった<sup id="fnref:有線接続"><a href="#fndef:有線接続" class=fnref >[5]</a></sup> のでトライバンドメッシュ Wi-Fi を導入しました。</p> <h4 id="スイッチングハブ"><a href="#スイッチングハブ" class=header-anchor >スイッチングハブ</a></h4> <p>100Mbps スイッチングハブを駆逐し（逆になぜ生きていたんだ）、 10GbE に対応したスイッチングハブを導入しました。<br/> <code>my new gear...</code> とか言ってますが、僕のでは無いです。 <blockquote class=twitter-tweet  data-theme=dark ><p lang=en  dir=ltr >my new gear... <a href="https://t.co/q3HrhkyQTC">pic.twitter.com/q3HrhkyQTC</a></p>&mdash; へいほぅ (@5ebec) <a href="https://twitter.com/5ebec/status/1278714547629461510?ref_src=twsrc%5Etfw">July 2, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset=utf-8 ></script> </p> <p>配線後はこんな感じになりました<sup id="fnref:電源"><a href="#fndef:電源" class=fnref >[6]</a></sup>。 <figure> <img src="/img/2020-12-18/rack.jpg"/> <figcaption>スイッチングハブ等が置いてあるラック。</figcaption> </figure> </p> <h3 id="dhcp_サーバを構築した"><a href="#dhcp_サーバを構築した" class=header-anchor >DHCP サーバを構築した</a></h3> <p>余っていた Raspberry Pi で軽量 DNS/DHCP サーバを作りました。</p> <p>何故このようなことをしたのかというと、旧 A2 ネットでは無線 LAN ルーター内蔵の DHCP サーバ機能を使っており、そのルーターでは最大 16 台までしかリース出来ないという仕様でした。 そのため、各クライアント側で他の端末と被らないような IP アドレスを手動で固定してもらうという超原始的な方法を取っていました。 基本的には 1 回設定してしまえばそれで良いのですが、新しい端末を接続する度にその設定をするのは面倒だと感じたので、DHCP サーバを別で建てることにしたというわけです。</p> <p>ソフトウェアには <a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">Dnsmasq</a> を用いました。 この規模であればラズパイと Dnsmasq を用いれば簡単に構築出来るので良いですね。</p> <p><code>dnsmasq.conf</code> の <code>conf-file&#61;/etc/dnsmasq.more.conf</code> の行のコメントを外し、<code>dnsmasq.more.conf</code> に以下を記述しました。</p> <pre><code class="julia hljs"><span class=hljs-comment >#######</span>
<span class=hljs-comment ># DNS #</span>
<span class=hljs-comment >#######</span>
domain-needed
bogus-priv
<span class=hljs-keyword >local</span> = /a2net/
domain = a2net
no-hosts
addn-hosts = /etc/hosts_dnsmasq

<span class=hljs-comment >########</span>
<span class=hljs-comment ># DHCP #</span>
<span class=hljs-comment >########</span>
expand-hosts
dhcp-range = <span class=hljs-number >192.168</span><span class=hljs-number >.0</span><span class=hljs-number >.2</span>, <span class=hljs-number >192.168</span><span class=hljs-number >.0</span><span class=hljs-number >.199</span>, <span class=hljs-number >12</span>h
dhcp-option = option:netmask, <span class=hljs-number >255.255</span><span class=hljs-number >.255</span><span class=hljs-number >.0</span>
dhcp-option = option:router, <span class=hljs-number >192.168</span><span class=hljs-number >.0</span><span class=hljs-number >.1</span>
dhcp-option = option:dns-server, <span class=hljs-number >192.168</span><span class=hljs-number >.0</span><span class=hljs-number >.200</span>, <span class=hljs-number >192.168</span><span class=hljs-number >.0</span><span class=hljs-number >.1</span>, <span class=hljs-number >8.8</span><span class=hljs-number >.8</span><span class=hljs-number >.8</span>
dhcp-option = option:ntp-server, <span class=hljs-number >192.168</span><span class=hljs-number >.0</span><span class=hljs-number >.1</span>

<span class=hljs-comment ># static leases (Access Point)</span>
<span class=hljs-comment ># ここでアクセスポイントのIPアドレスを固定する</span>
dhcp-host = xx:xx:xx:xx:xx:xx, xxx, <span class=hljs-number >192.168</span><span class=hljs-number >.0</span>.xxx

<span class=hljs-comment >#######</span>
<span class=hljs-comment ># log #</span>
<span class=hljs-comment >#######</span>
<span class=hljs-comment >#log-dhcp</span>
log-facility = /var/log/dnsmasq.log</code></pre> <p>アクセスポイント等は IP アドレスを固定し、それ以外のクライアントは 198 台まで自動で IP アドレスを割り当てられるようにしました。 12 時間以内に 198 台以上接続されることは無かったので、今のところこれで問題はないです。</p> <p>このサーバには<a href="https://mackerel.io/ja/">Mackerel</a>を導入して死活監視し、LINE Notify で通知が来るようにしています。やりたいだけです。</p> <p><img src="/img/2020-12-18/dhcpserver_hub.jpg" alt="DHCPサーバ" /></p> <h3 id="ドキュメント等を_github_google_drive_で管理するようにした"><a href="#ドキュメント等を_github_google_drive_で管理するようにした" class=header-anchor >ドキュメント等を GitHub &#43; Google Drive で管理するようにした</a></h3> <p>おまけ。<br/> 利用者のためのマニュアル、conf ファイル、各種ドキュメント等は GitHub Organization を用いて管理しています。</p> <p>そして GitHub Actions を用いて <code>rclone</code> で Google Drive にアップロードするような Workflow を書いています。 マニュアルは Google Drive の共有機能を使って利用者に共有しているのですが、その更新は <code>git push</code> するだけでいいので便利です。</p> <p>また、万が一引き継ぎ時に GitHub はどうしても使いたくないと言われた場合でも、スムーズに引き継ぎが行えますね。</p> <pre><code class="yaml hljs"><span class=hljs-attr >name:</span> <span class=hljs-string >Upload</span> <span class=hljs-string >to</span> <span class=hljs-string >Google</span> <span class=hljs-string >Drive</span>

<span class=hljs-attr >on:</span>
  <span class=hljs-attr >push:</span>
    <span class=hljs-attr >branches:</span> [ <span class=hljs-string >master</span> ]

<span class=hljs-attr >jobs:</span>
  <span class=hljs-attr >upload:</span>
    <span class=hljs-attr >runs-on:</span> <span class=hljs-string >ubuntu-latest</span>

    <span class=hljs-attr >steps:</span>
    <span class=hljs-bullet >-</span> <span class=hljs-attr >name:</span> <span class=hljs-string >checkout</span>
      <span class=hljs-attr >uses:</span> <span class=hljs-string >actions/checkout@v2</span>
    
    <span class=hljs-bullet >-</span> <span class=hljs-attr >name:</span> <span class=hljs-string >setup</span> <span class=hljs-string >rclone</span>
      <span class=hljs-attr >env:</span>
        <span class=hljs-attr >RCLONE_CONF:</span> <span class=hljs-string >${{</span> <span class=hljs-string >secrets.RCLONE_CONF</span> <span class=hljs-string >}}</span>
      <span class=hljs-attr >run:</span> <span class=hljs-string >|
        curl https://rclone.org/install.sh | sudo bash
        mkdir -p /home/runner/.config/rclone
        echo &quot;$RCLONE_CONF&quot; &gt; /home/runner/.config/rclone/rclone.conf
</span>        
    <span class=hljs-bullet >-</span> <span class=hljs-attr >name:</span> <span class=hljs-string >upload</span> <span class=hljs-string >to</span> <span class=hljs-string >Google</span> <span class=hljs-string >Drive</span>
      <span class=hljs-attr >run:</span> <span class=hljs-string >rclone</span> <span class=hljs-string >copy</span> <span class=hljs-string >--exclude</span> <span class=hljs-string >&#x27;.*{/**,}&#x27;</span> <span class=hljs-string >./</span> <span class=hljs-string >gdrive:$GITHUB_REPOSITORY</span></code></pre> <p><table class=fndef  id="fndef:タイミング"> <tr> <td class=fndef-backref ><a href="#fnref:タイミング">[4]</a> <td class=fndef-content >COVID-19 の影響で結構待たされた記憶があります。 </table> <table class=fndef  id="fndef:有線接続"> <tr> <td class=fndef-backref ><a href="#fnref:有線接続">[5]</a> <td class=fndef-content >LAN ケーブルは天井に這わせることしか考えていなかったので有線接続出来ないと思っていたのですが、最近、事務室の扉の下の隙間からケーブルを通している人がいて、なるほどなぁと思いました（小並感）。 </table> <table class=fndef  id="fndef:電源"> <tr> <td class=fndef-backref ><a href="#fnref:電源">[6]</a> <td class=fndef-content >ちなみにここの電源は居室からではなく、廊下のコンセントから取っています。これは居室のブレーカーが落ちると全居室のネットが切断されるためです。クーラーを使用している中で電子レンジと湯沸かし器を同時に使うと簡単に落とせます。僕が 2 回くらいやらかしました。 </table> </p> <h2 id="結果"><a href="#結果" class=header-anchor >結果</a></h2> <p>以下に新 A2 ネットの構成図を示しておきます。厳密な図ではありません。 <figure> <img src="/img/2020-12-18/a2net_new.png"/> <figcaption>新A2ネット構成図。</figcaption> </figure> </p> <p>例えば談話室では、時間帯によって異なりますが、上り下り共に実測値で 200〜700Mbps の速度が出ます。オンラインゲームをするには十分過ぎる速度だと思います<sup id="fnref:回線速度"><a href="#fndef:回線速度" class=fnref >[7]</a></sup> 。</p> <p>居室では 20〜600Mbps くらい出ることを確認しています。振れ幅が大きいのは居室内のネットワーク機器の性能差によるものです。多分僕の知らないところに 100Mbps ハブがあるんだと思います。 僕の部屋は大体 300Mbps くらい出ますし、寮の会議中でも 150Mbps は出ています。</p> <p>管理者の意思で全てのアクセスポイントのパスワードを変えることが可能となったので、例えば毎年 4 月は無料で A2 ネットを体験してもらい、5 月以降も続けて使いたい人は A2 ネットに加入してもらうみたいなこと<sup id="fnref:強制的無料体験"><a href="#fndef:強制的無料体験" class=fnref >[8]</a></sup> も可能です。夢が広がりますね。</p> <table class=fndef  id="fndef:回線速度"> <tr> <td class=fndef-backref ><a href="#fnref:回線速度">[7]</a> <td class=fndef-content >一般に、インターネット回線でストレスなく通信出来る速度は 10〜30Mbps 程度と言われています。また、オンラインゲームなど大容量通信を行う環境では 100Mbps 以上の回線速度が理想的です。 </table> <table class=fndef  id="fndef:強制的無料体験"> <tr> <td class=fndef-backref ><a href="#fnref:強制的無料体験">[8]</a> <td class=fndef-content >「一ヶ月無料体験」はサブスクリプションサービスでよく利用される手口ですね。<a href="https://en.wikipedia.org/wiki/Endowment_effect">保有効果</a>と言います。勿論、サービスがゴミだと思われては解約されるので、ある程度の質は必要です。 </table> <h2 id="結論と宣伝"><a href="#結論と宣伝" class=header-anchor >結論と宣伝</a></h2> <p>対象がなんであれシステムの改善は楽しいですね。 もっと弄りたいとは思っていますが、やればやるほど引き継ぎが難しくなるので我慢しています（アクセスポイントのパスワードを変える際、全ての管理画面に入って 1 個ずつ変更するという作業はかなり面倒なので、これを簡単にするくらいはやりたいなぁと思っています）。</p> <p>さて、僕は今年度でここを出るので跡継ぎが必要です。 ちゃんとドキュメントは残していますし、引き継ぎはちゃんとします。 僕が退寮した後であっても分からないことがあれば何でも言ってくれて構わないので誰かやってください。お願いします。</p> <p>最強のネットワーク環境が欲しい未来の京大生、小中規模のネットワークを自由に構築したい京大生、熊野寮 A2 ブロックに来て、A2 ネットを改善しませんか？</p> <footer class=page-foot > <div class=copyright > <span> &copy; 2019-2021 <a href="https://a5e.be/c">5ebec</a> </span> <span>::Powered py <a href="https://franklinjl.org/">Franklin.jl</a></span> </div> </footer> </div> <script src="/libs/highlight/highlight.min.js"></script> <script src="/libs/highlight/ln.min.js"></script> <script> hljs.initHighlightingOnLoad(); hljs.initLineNumbersOnLoad({ singleLine: true }); hljs.configure({ tabReplace: " " }); </script>